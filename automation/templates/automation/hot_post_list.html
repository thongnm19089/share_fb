{% extends 'automation/base.html' %}
{% block content %}
<div class="d-flex justify-content-between mb-3 align-items-center">
    <div class="d-flex align-items-center">
        <h3 class="mb-0">Bài Viết Nổi Bật (Lịch sử)</h3>
        <select id="sort-select" class="form-select form-select-sm ms-3" style="width: auto;">
            <option value="engagement" selected>Tương tác Cao nhất</option>
            <option value="time">Bài mới nhất</option>
        </select>
    </div>
    <div>
        <button id="btn-scrape-all" class="btn btn-success me-2"><i class="fas fa-robot"></i> Quét Tất Cả Pages</button>
        <a href="{% url 'page_list' %}" class="btn btn-outline-primary"><i class="fas fa-cog"></i> Quản lý Pages</a>
    </div>
</div>

<div id="scrape-progress-wrapper" class="d-none mb-4">
    <h5>Đang quét dữ liệu... <span id="scrape-percent">0</span>%</h5>
    <div class="progress" style="height: 25px;">
        <div id="scrape-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
            role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
</div>

<div id="posts-container" class="row">
</div>

<div class="col-12 text-center py-4" id="scroll-detector">
    <button id="btn-load-more" class="btn btn-outline-secondary d-none">Đang tải...</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const btnScrapeAll = document.getElementById('btn-scrape-all');
        const progressWrapper = document.getElementById('scrape-progress-wrapper');
        const progressBar = document.getElementById('scrape-progress-bar');
        const progressPercent = document.getElementById('scrape-percent');
        const postsContainer = document.getElementById('posts-container');
        const emptyState = document.getElementById('empty-state');

        let pollInterval;

        btnScrapeAll.addEventListener('click', function () {
            if (!confirm('Bắt đầu quét TẤT CẢ các Pages (có bật Tự động Quét)? Dữ liệu sẽ lưu vào DB.')) return;

            btnScrapeAll.disabled = true;
            // Optionally clear old data before running new scan to avoid duplicates being shown right away
            // postsContainer.innerHTML = ''; 
            progressWrapper.classList.remove('d-none');
            updateProgress(0);

            fetch("{% url 'api_start_scrape' %}")
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert(data.message);
                        resetUI();
                        return;
                    }

                    const jobId = data.job_id;
                    // Start polling every 2 seconds
                    pollInterval = setInterval(() => checkStatus(jobId), 2000);
                })
                .catch(err => {
                    alert("Lỗi khi gọi API: " + err);
                    resetUI();
                });
        });

        function checkStatus(jobId) {
            fetch(`/api/scrape/status/${jobId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert("Lỗi trong quá trình quét: " + (data.error || data.message));
                        clearInterval(pollInterval);
                        resetUI();
                        return;
                    }

                    updateProgress(data.progress);

                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        setTimeout(() => {
                            progressWrapper.classList.add('d-none');
                            btnScrapeAll.disabled = false;
                            // Reset và tải lại danh sách từ DB (tự động hiển thị sau quét)
                            currentPage = 1;
                            hasMore = true;
                            lastRenderedDate = null;
                            postsContainer.innerHTML = '';
                            loadHistoryPosts();
                        }, 500);
                    }
                })
                .catch(err => console.error(err));
        }

        function updateProgress(pct) {
            progressBar.style.width = pct + '%';
            progressBar.setAttribute('aria-valuenow', pct);
            progressPercent.textContent = pct;
        }

        function resetUI() {
            btnScrapeAll.disabled = false;
            progressWrapper.classList.add('d-none');
        }

        function formatRelativeTime(dateString) {
            if (!dateString) return 'N/A';
            const postDate = new Date(dateString);
            const now = new Date();

            const hours = postDate.getHours().toString().padStart(2, '0');
            const minutes = postDate.getMinutes().toString().padStart(2, '0');
            let timeStr = `${hours}:${minutes}`;

            const isToday = postDate.getDate() === now.getDate() &&
                postDate.getMonth() === now.getMonth() &&
                postDate.getFullYear() === now.getFullYear();

            if (isToday) {
                const diffMs = now - postDate;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));

                if (diffHrs > 0) {
                    timeStr += ` (${diffHrs} giờ trước)`;
                } else {
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    if (diffMins > 0) {
                        timeStr += ` (${diffMins} phút trước)`;
                    } else {
                        timeStr += ` (Vừa xong)`;
                    }
                }
            }
            return timeStr;
        }

        let lastRenderedDate = null; // Dùng để theo dõi dải phân cách ngày

        function appendPosts(results) {
            if (!results || results.length === 0) {
                if (postsContainer.innerHTML.trim() === '') {
                    postsContainer.innerHTML = `
                    <div class="col-12 text-center py-5 text-muted w-100">
                        <h4>Không có bài viết nào trong Lịch sử</h4>
                    </div>`;
                }
                return;
            }

            let html = '';
            results.forEach(post => {
                const timeStr = formatRelativeTime(post.posted_at);

                // Grouping by Date logic
                const currentDateGroup = post.post_date || 'Unknown Date';
                if (currentDateGroup !== lastRenderedDate) {
                    lastRenderedDate = currentDateGroup;
                    let displayDate = currentDateGroup;
                    if (currentDateGroup === new Date().toISOString().split('T')[0]) {
                        displayDate = "Ngày Hôm Nay";
                    }
                    html += `
                    <div class="col-12 mt-4 mb-3">
                        <div class="d-flex align-items-center">
                            <hr class="flex-grow-1 border-primary opacity-25">
                            <span class="badge bg-primary rounded-pill px-3 py-2 mx-3 fs-6"><i class="far fa-calendar-alt me-2"></i>${displayDate}</span>
                            <hr class="flex-grow-1 border-primary opacity-25">
                        </div>
                    </div>`;
                }

                const borderClass = post.total_engagement > 100 ? 'success' : 'secondary';
                const defaultSnippet = "[Không có nội dung text]";

                html += `
            <div class="col-6 col-sm-6 col-md-4 col-xl-3 mb-2">
                <div class="card h-100 shadow-sm border-${borderClass}" style="background:#f8f9fa;">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-1 px-2">
                        <span class="fw-bold text-primary text-truncate flex-grow-1 small" style="font-size:0.85rem;"><i class="fas fa-flag"></i> ${post.page_name || 'Page'}</span>
                        <a href="${post.post_url}" target="_blank" class="text-decoration-none text-primary ms-1 text-nowrap" style="font-size:0.8rem;" title="Xem Bài">
                            <i class="far fa-clock"></i> ${timeStr}
                        </a>
                    </div>
                    <div class="card-body py-1 px-2 d-flex flex-column" style="background:#f8f9fa;">
                        <p class="card-text mb-1"
                            style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-size: 0.88rem;">
                            ${post.content_snippet || defaultSnippet}
                        </p>
                        <div class="mt-auto" style="padding-bottom:2px;">
                        <hr class="my-1">
                        <div class="d-flex justify-content-between text-muted" style="font-size:0.8rem;">
                            <span title="Likes"><i class="fas fa-thumbs-up text-primary"></i> ${post.likes || 0}</span>
                            <span title="Comments"><i class="fas fa-comment text-warning"></i> ${post.comments || 0}</span>
                            <span title="Shares"><i class="fas fa-share text-success"></i> ${post.shares || 0}</span>
                            <strong title="Total Engagement" class="text-danger"><i class="fas fa-fire"></i> ${post.total_engagement || 0}</strong>
                        </div>
                        </div>
                    </div>
                </div>
            </div>`;
            });

            postsContainer.insertAdjacentHTML('beforeend', html);
        }

        // Logic for infinite scrolling / load more historic posts
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const btnLoadMore = document.getElementById('btn-load-more');

        let currentSort = 'engagement';
        const sortSelect = document.getElementById('sort-select');

        sortSelect.addEventListener('change', function () {
            currentSort = this.value;
            currentPage = 1;
            hasMore = true;
            lastRenderedDate = null;
            postsContainer.innerHTML = ''; // Reset ui
            loadHistoryPosts();
        });

        function loadHistoryPosts() {
            if (isLoading || !hasMore) return;
            isLoading = true;
            btnLoadMore.classList.remove('d-none');
            btnLoadMore.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tải...';

            fetch(`/api/posts/?page=${currentPage}&sort=${currentSort}`)
                .then(res => res.json())
                .then(data => {
                    isLoading = false;
                    if (data.status === 'ok') {
                        appendPosts(data.results);
                        hasMore = data.has_next;
                        if (hasMore) {
                            currentPage++;
                            btnLoadMore.textContent = "Cuộn xuống để xem thêm...";
                        } else {
                            btnLoadMore.classList.add('d-none');
                        }
                    }
                })
                .catch(err => {
                    isLoading = false;
                    console.error("Lỗi tải lịch sử:", err);
                });
        }

        // Set up IntersectionObserver for Infinite Scrolling
        const observerOptions = {
            root: null,          // viewport - body scroll tự nhiên
            rootMargin: '400px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    loadHistoryPosts();
                }
            });
        }, observerOptions);

        observer.observe(document.getElementById('scroll-detector'));

        // Fallback window scroll
        window.addEventListener('scroll', function () {
            if (!hasMore || isLoading) return;
            if (window.scrollY + window.innerHeight >= document.documentElement.scrollHeight - 300) {
                loadHistoryPosts();
            }
        });

        loadHistoryPosts();
    });
</script>
{% endblock %}